# 2021电赛D题方案（更新中）

## 文件夹构成
raspberry: 摄像节点A和B代码和配置文件，使用同一套代码，只有IP配置不同

## 摄像节点端详解
摄像节点所做的事非常少，总共分为两件事
* 读取usb摄像头的图像并显示
* 监听8001端口，如果有设备连接上来，就开始进行图像传输

#### 依赖的库
python版本：python3.6及以上  
只需要opencv和opencv_contrib

#### send.py
该文件定义了一个Send类，基于TCP协议，监听本地端口，同时提供了传输图像的函数  
主要特性如下
* 支持掉线重连，方便调试，不会出现在调试nano端图像处理代码时，每次启动代码还要重启节点的代码
* 将二维图像降维成一维并编码压缩，在nano端恢复
* 在传输图像的同时传输时间，因为网络延迟的原因，nano端接收到图像的时间其实是不准的，
通过在发送时将发送时间一并发送，可以保证网络出现延迟时nano端收到的时间是准确的
* 传输图像的可靠性由TCP协议保证

#### fix_distortion.py
该文件提供了摄像头畸变矫正功能，是我的队友张同学用matlab计算参数提供，据他说可以矫正畸变，
但是我的肉眼不能分辨添加之后是否有不同，是否有该文件对结果没有任何影响。

#### raspberry.py
树莓派端的主文件，实现了读取视频流和传输视频，需要指出以下几点
1. 创建的显示图像的窗口需要自适应大小，同时设置始终置顶
2. 读取图像和传输图像需要使用双线程以解决帧滞留问题（该问题导致去年省赛识别题只拿了省二，具体定义可以百度）
3. usb摄像头分辨率为480P，即640*480，使用千兆交换机传输帧数每秒可达25帧以上

#### 图像传输协议
* 首先传送16个字节，该字节表示该图像发送时的时间
* 其次再次传送16个字节，该字节表示图像数据的长度
* 压缩后的图像数据直接跟在后面

#### 节点IP配置
终端输入sudo vim /etc/network/interfaces，内容改为本仓库中raspberry/interfaces的内容

#### 开机自启动配置
在/home/pi/.config/autostart(如果没有该目录就创建它)，将本仓库中raspberry/opencvtest.desktop复制进去，
该文件中Exec=/home/pi/opencvtest/opencvtest.sh表示需要执行的shell脚本的路径，编写一个shell脚本启动程序就可以了
